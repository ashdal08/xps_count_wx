<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>gevent.pywsgi - XPS Count 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/./furo_mod.css?v=51d201ec" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">XPS Count 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="content-icon-container">
    <div class="theme-toggle-container theme-toggle-content">
      <button class="theme-toggle">
        <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
        <svg class="theme-icon-when-auto-light">
          <use href="#svg-sun-with-moon"></use>
        </svg>
        <svg class="theme-icon-when-auto-dark">
          <use href="#svg-moon-with-sun"></use>
        </svg>
        <svg class="theme-icon-when-dark">
          <use href="#svg-moon"></use>
        </svg>
        <svg class="theme-icon-when-light">
          <use href="#svg-sun"></use>
        </svg>
      </button>
    </div>
  </div><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">XPS Count 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../xps_count.html">Main Program Window</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mainframe.html">mainframe GUI module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot_server.html">Plot Server</a></li>
</ul>

</div></div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for gevent.pywsgi</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2005-2009, eventlet contributors</span>
<span class="c1"># Copyright (c) 2009-2018, gevent contributors</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A pure-Python, gevent-friendly WSGI server implementing HTTP/1.1.</span>

<span class="sd">The server is provided in :class:`WSGIServer`, but most of the actual</span>
<span class="sd">WSGI work is handled by :class:`WSGIHandler` --- a new instance is</span>
<span class="sd">created for each request. The server can be customized to use</span>
<span class="sd">different subclasses of :class:`WSGIHandler`.</span>

<span class="sd">.. important::</span>

<span class="sd">   This server is intended primarily for development and testing, and</span>
<span class="sd">   secondarily for other &quot;safe&quot; scenarios where it will not be exposed to</span>
<span class="sd">   potentially malicious input. The code has not been security audited,</span>
<span class="sd">   and is not intended for direct exposure to the public Internet. For production</span>
<span class="sd">   usage on the Internet, either choose a production-strength server such as</span>
<span class="sd">   gunicorn, or put a reverse proxy between gevent and the Internet.</span>

<span class="sd">.. versionchanged:: 23.9.0</span>

<span class="sd">   Complies more closely with the HTTP specification for chunked transfer encoding.</span>
<span class="sd">   In particular, we are much stricter about trailers, and trailers that</span>
<span class="sd">   are invalid (too long or featuring disallowed characters) forcibly close</span>
<span class="sd">   the connection to the client *after* the results have been sent.</span>

<span class="sd">   Trailers otherwise continue to be ignored and are not available to the</span>
<span class="sd">   WSGI application.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c1"># FIXME: Can we refactor to make smallor?</span>
<span class="c1"># pylint:disable=too-many-lines</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">unquote</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gevent</span><span class="w"> </span><span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gevent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gevent.server</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamServer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gevent.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">GreenletExit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gevent._compat</span><span class="w"> </span><span class="kn">import</span> <span class="n">reraise</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="n">unquote_latin1</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">unquote</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

<span class="n">_no_undoc_members</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Don&#39;t put undocumented things into sphinx</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;WSGIServer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WSGIHandler&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LoggingLogAdapter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Environ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SecureEnviron&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WSGISecureEnviron&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">MAX_REQUEST_LINE</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="c1"># Weekday and month names for HTTP date/time formatting; always English!</span>
<span class="n">_WEEKDAYNAME</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">)</span>
<span class="n">_MONTHNAME</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Dummy so we can use 1-based month numbers</span>
              <span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="s2">&quot;Mar&quot;</span><span class="p">,</span> <span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="s2">&quot;Dec&quot;</span><span class="p">)</span>

<span class="c1"># The contents of the &quot;HEX&quot; grammar rule for HTTP, upper and lowercase A-F plus digits,</span>
<span class="c1"># in byte form for comparing to the network.</span>
<span class="n">_HEX</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">hexdigits</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

<span class="c1"># The characters allowed in &quot;token&quot; rules.</span>

<span class="c1"># token          = 1*tchar</span>
<span class="c1"># tchar          = &quot;!&quot; / &quot;#&quot; / &quot;$&quot; / &quot;%&quot; / &quot;&amp;&quot; / &quot;&#39;&quot; / &quot;*&quot;</span>
<span class="c1">#                / &quot;+&quot; / &quot;-&quot; / &quot;.&quot; / &quot;^&quot; / &quot;_&quot; / &quot;`&quot; / &quot;|&quot; / &quot;~&quot;</span>
<span class="c1">#                / DIGIT / ALPHA</span>
<span class="c1">#                ; any VCHAR, except delimiters</span>
<span class="c1"># ALPHA          =  %x41-5A / %x61-7A   ; A-Z / a-z</span>
<span class="n">_ALLOWED_TOKEN_CHARS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="c1"># Remember we have to be careful because bytestrings</span>
    <span class="c1"># inexplicably iterate as integers, which are not equal to bytes.</span>

    <span class="c1"># explicit chars then DIGIT</span>
    <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;!#$%&amp;&#39;*+-.^_`|~0123456789&quot;</span><span class="p">)</span>
    <span class="c1"># Then we add ALPHA</span>
<span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">}</span>
<span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">_ALLOWED_TOKEN_CHARS</span>


<span class="c1"># Errors</span>
<span class="n">_ERRORS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_INTERNAL_ERROR_STATUS</span> <span class="o">=</span> <span class="s1">&#39;500 Internal Server Error&#39;</span>
<span class="n">_INTERNAL_ERROR_BODY</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Internal Server Error&#39;</span>
<span class="n">_INTERNAL_ERROR_HEADERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_INTERNAL_ERROR_BODY</span><span class="p">)))</span>
<span class="p">)</span>
<span class="n">_ERRORS</span><span class="p">[</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_INTERNAL_ERROR_STATUS</span><span class="p">,</span> <span class="n">_INTERNAL_ERROR_HEADERS</span><span class="p">,</span> <span class="n">_INTERNAL_ERROR_BODY</span><span class="p">)</span>

<span class="n">_BAD_REQUEST_STATUS</span> <span class="o">=</span> <span class="s1">&#39;400 Bad Request&#39;</span>
<span class="n">_BAD_REQUEST_BODY</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">_BAD_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_BAD_REQUEST_BODY</span><span class="p">)))</span>
<span class="p">)</span>
<span class="n">_ERRORS</span><span class="p">[</span><span class="mi">400</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BAD_REQUEST_STATUS</span><span class="p">,</span> <span class="n">_BAD_REQUEST_HEADERS</span><span class="p">,</span> <span class="n">_BAD_REQUEST_BODY</span><span class="p">)</span>

<span class="n">_REQUEST_TOO_LONG_RESPONSE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 414 Request URI Too Long</span><span class="se">\r\n</span><span class="s2">Connection: close</span><span class="se">\r\n</span><span class="s2">Content-length: 0</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<span class="n">_BAD_REQUEST_RESPONSE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 400 Bad Request</span><span class="se">\r\n</span><span class="s2">Connection: close</span><span class="se">\r\n</span><span class="s2">Content-length: 0</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<span class="n">_CONTINUE_RESPONSE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 100 Continue</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">format_date_time</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="c1"># Return a byte-string of the date and time in HTTP format</span>
    <span class="c1"># .. versionchanged:: 1.1b5</span>
    <span class="c1">#  Return a byte string, not a native string</span>
    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_z</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%02d</span><span class="s2"> </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2"> GMT&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_WEEKDAYNAME</span><span class="p">[</span><span class="n">wd</span><span class="p">],</span> <span class="n">day</span><span class="p">,</span> <span class="n">_MONTHNAME</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">year</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_InvalidClientInput</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
    <span class="c1"># Internal exception raised by Input indicating that the client</span>
    <span class="c1"># sent invalid data at the lowest level of the stream. The result</span>
    <span class="c1"># *should* be a HTTP 400 error.</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_InvalidClientRequest</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="c1"># Internal exception raised by WSGIHandler.read_request indicating</span>
    <span class="c1"># that the client sent an HTTP request that cannot be parsed</span>
    <span class="c1"># (e.g., invalid grammar). The result *should* be an HTTP 400</span>
    <span class="c1"># error. It must have exactly one argument, the fully formatted</span>
    <span class="c1"># error string.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="ne">ValueError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatted_message</span> <span class="o">=</span> <span class="n">message</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;rfile&#39;</span><span class="p">,</span> <span class="s1">&#39;content_length&#39;</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;chunked_input&#39;</span><span class="p">,</span> <span class="s1">&#39;chunk_length&#39;</span><span class="p">,</span> <span class="s1">&#39;_chunked_input_error&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">socket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunked_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># pylint:disable=redefined-outer-name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="n">content_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_input</span> <span class="o">=</span> <span class="n">chunked_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span><span class="p">:</span>
            <span class="c1"># We are in an unknown state, so we can&#39;t necessarily discard</span>
            <span class="c1"># the body (e.g., if the client keeps the socket open, we could hang</span>
            <span class="c1"># here forever).</span>
            <span class="c1"># In this case, we&#39;ve raised an exception and the user of this object</span>
            <span class="c1"># is going to close the socket, so we don&#39;t have to discard</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_input</span><span class="p">):</span>
            <span class="c1"># ## Read and discard body</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16384</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_send_100_continue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">_CONTINUE_RESPONSE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_readline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">use_readline</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Either Content-Length or &quot;Transfer-Encoding: chunked&quot; must be present in a request with a body</span>
            <span class="c1"># if it was chunked, then this function would have not been called</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_send_100_continue</span><span class="p">()</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">content_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">left</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">left</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

        <span class="c1"># On Python 2, self.rfile is usually socket.makefile(), which</span>
        <span class="c1"># uses cStringIO.StringIO. If *length* is greater than the C</span>
        <span class="c1"># sizeof(int) (typically 32 bits signed), parsing the argument to</span>
        <span class="c1"># readline raises OverflowError. StringIO.read(), OTOH, uses</span>
        <span class="c1"># PySize_t, typically a long (64 bits). In a bare readline()</span>
        <span class="c1"># case, because the header lines we&#39;re trying to read with</span>
        <span class="c1"># readline are typically expected to be small, we can correct</span>
        <span class="c1"># that failure by simply doing a smaller call to readline and</span>
        <span class="c1"># appending; failures in read we let propagate.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_readline</span><span class="p">:</span>
                <span class="c1"># Expecting to read more than 64 bits of data. Ouch!</span>
                <span class="k">raise</span>
            <span class="c1"># We could loop on calls to smaller readline(), appending them</span>
            <span class="c1"># until we actually get a newline. For uses in this module,</span>
            <span class="c1"># we expect the actual length to be small, but WSGI applications</span>
            <span class="c1"># are allowed to pass in an arbitrary length. (This loop isn&#39;t optimal,</span>
            <span class="c1"># but even client applications *probably* have short lines.)</span>
            <span class="n">read</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">read</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">read</span> <span class="o">+=</span> <span class="n">reader</span><span class="p">(</span><span class="n">MAX_REQUEST_LINE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">use_readline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">read</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">use_readline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;unexpected end of file while reading request at position </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,))</span>

        <span class="k">return</span> <span class="n">read</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__read_chunk_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">):</span>
        <span class="c1"># Read and return the next integer chunk length. If no</span>
        <span class="c1"># chunk length can be read, raises _InvalidClientInput.</span>

        <span class="c1"># Here&#39;s the production for a chunk (actually the whole body):</span>
        <span class="c1"># (https://www.rfc-editor.org/rfc/rfc7230#section-4.1)</span>

        <span class="c1"># chunked-body   = *chunk</span>
        <span class="c1">#                  last-chunk</span>
        <span class="c1">#                  trailer-part</span>
        <span class="c1">#                  CRLF</span>
        <span class="c1">#</span>
        <span class="c1"># chunk          = chunk-size [ chunk-ext ] CRLF</span>
        <span class="c1">#                  chunk-data CRLF</span>
        <span class="c1"># chunk-size     = 1*HEXDIG</span>
        <span class="c1"># last-chunk     = 1*(&quot;0&quot;) [ chunk-ext ] CRLF</span>
        <span class="c1"># trailer-part   = *( header-field CRLF )</span>
        <span class="c1"># chunk-data     = 1*OCTET ; a sequence of chunk-size octets</span>
        <span class="c1">#</span>
        <span class="c1"># chunk-ext      = *( &quot;;&quot; chunk-ext-name [ &quot;=&quot; chunk-ext-val ] )</span>
        <span class="c1">#</span>
        <span class="c1"># chunk-ext-name = token</span>
        <span class="c1"># chunk-ext-val  = token / quoted-string</span>

        <span class="c1"># To cope with malicious or broken clients that fail to send</span>
        <span class="c1"># valid chunk lines, the strategy is to read character by</span>
        <span class="c1"># character until we either reach a ; or newline. If at any</span>
        <span class="c1"># time we read a non-HEX digit, we bail. If we hit a ;,</span>
        <span class="c1"># indicating an chunk-extension, we&#39;ll read up to the next</span>
        <span class="c1"># MAX_REQUEST_LINE characters (&quot;A server ought to limit the</span>
        <span class="c1"># total length of chunk extensions received&quot;) looking for the</span>
        <span class="c1"># CRLF, and if we don&#39;t find it, we bail. If we read more than</span>
        <span class="c1"># 16 hex characters, (the number needed to represent a 64-bit</span>
        <span class="c1"># chunk size), we bail (this protects us from a client that</span>
        <span class="c1"># sends an infinite stream of `F`, for example).</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">char</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;EOF before chunk end reached&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="c1"># Beginning EOL</span>
                <span class="sa">b</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="c1"># Beginning extension</span>
            <span class="p">):</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_HEX</span><span class="p">:</span> <span class="c1"># Invalid data.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Non-hex data&quot;</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>

            <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span> <span class="c1"># Too many hex bytes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Chunk-size too large.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;;&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REQUEST_LINE</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we read more than MAX_REQUEST_LINE without</span>
                <span class="c1"># hitting CR</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Too large chunk extension&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="c1"># We either got here from the main loop or from the</span>
            <span class="c1"># end of an extension</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__read_chunk_size_crlf</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="n">newline_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># The only time a chunk size of zero is allowed is the final</span>
                <span class="c1"># chunk. It is either followed by another \r\n, or some trailers</span>
                <span class="c1"># which are then followed by \r\n.</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_chunk_trailer</span><span class="p">(</span><span class="n">rfile</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Trailers have the following production (they are a header-field followed by CRLF)</span>
    <span class="c1"># See above for the definition of &quot;token&quot;.</span>
    <span class="c1">#</span>
    <span class="c1"># header-field   = field-name &quot;:&quot; OWS field-value OWS</span>
    <span class="c1"># field-name     = token</span>
    <span class="c1"># field-value    = *( field-content / obs-fold )</span>
    <span class="c1"># field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]</span>
    <span class="c1"># field-vchar    = VCHAR / obs-text</span>
    <span class="c1"># obs-fold       = CRLF 1*( SP / HTAB )</span>
    <span class="c1">#                ; obsolete line folding</span>
    <span class="c1">#                ; see Section 3.2.4</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__read_chunk_trailer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="p">):</span>
        <span class="c1"># With rfile positioned just after a \r\n, read a trailer line.</span>
        <span class="c1"># Return a true value if a non-empty trailer was read, and</span>
        <span class="c1"># return false if an empty trailer was read (meaning the trailers are</span>
        <span class="c1"># done).</span>
        <span class="c1"># If a single line exceeds the MAX_REQUEST_LINE, raise an exception.</span>
        <span class="c1"># If the field-name portion contains invalid characters, raise an exception.</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">seen_field_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REQUEST_LINE</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="c1"># Either read the next \n or raise an error.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__read_chunk_size_crlf</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="n">newline_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="c1"># Not a \r, so we are NOT an empty chunk.</span>
            <span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;:&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># We&#39;re ending the field-name part; stop validating characters.</span>
                <span class="c1"># Unless : was the first character...</span>
                <span class="n">seen_field_name</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_field_name</span> <span class="ow">and</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_ALLOWED_TOKEN_CHARS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s1">&#39;Invalid token character: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">char</span><span class="p">,))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We read too much</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Too large chunk trailer&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">empty</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__read_chunk_size_crlf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">newline_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Also for safety, correctly verify that we get \r\n when expected.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newline_only</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Line didn&#39;t end in CRLF: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">char</span><span class="p">,))</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="n">_InvalidClientInput</span><span class="p">(</span><span class="s2">&quot;Line didn&#39;t end in LF: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">char</span><span class="p">,))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_chunked_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_readline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># pylint:disable=too-many-branches</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_100_continue</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">use_readline</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span>

        <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">maxreadlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
            <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">maxreadlen</span><span class="p">:</span>
                <span class="n">maxreadlen</span> <span class="o">=</span> <span class="n">length</span>

            <span class="k">if</span> <span class="n">maxreadlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">maxreadlen</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_input_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;unexpected end of file while parsing chunked data&quot;</span><span class="p">)</span>

                <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">datalen</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__read_chunk_size_crlf</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">length</span> <span class="o">-=</span> <span class="n">datalen</span>
                    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">use_readline</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;re at the beginning of a chunk, so we need to</span>
                <span class="c1"># determine the next size to read</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_chunk_length</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># If chunk_length was 0, we already read any trailers and</span>
                <span class="c1"># validated that we have ended with \r\n\r\n.</span>

        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_input</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_input</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked_read</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_read</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">use_readline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pylint:disable=unused-argument</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">mimetools</span>
    <span class="n">headers_factory</span> <span class="o">=</span> <span class="n">mimetools</span><span class="o">.</span><span class="n">Message</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># adapt Python 3 HTTP headers to old API</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">http</span><span class="w"> </span><span class="kn">import</span> <span class="n">client</span> <span class="c1"># pylint:disable=import-error</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">OldMessage</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPMessage</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPMessage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># pylint:disable=bad-super-call</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">getheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">typeheader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">headers_factory</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1"># pylint:disable=unused-argument</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">parse_headers</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_class</span><span class="o">=</span><span class="n">OldMessage</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">client</span><span class="o">.</span><span class="n">LineTooLong</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">OldMessage</span><span class="p">()</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Line too long&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WSGIHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles HTTP requests from a socket, creates the WSGI environment, and</span>
<span class="sd">    interacts with the WSGI application.</span>

<span class="sd">    This is the default value of :attr:`WSGIServer.handler_class`.</span>
<span class="sd">    This class may be subclassed carefully, and that class set on a</span>
<span class="sd">    :class:`WSGIServer` instance through a keyword argument at</span>
<span class="sd">    construction time.</span>

<span class="sd">    Instances are constructed with the same arguments as passed to the</span>
<span class="sd">    server&#39;s :meth:`WSGIServer.handle` method followed by the server</span>
<span class="sd">    itself. The application and environment are obtained from the server.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint:disable=too-many-instance-attributes</span>

    <span class="n">protocol_version</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">MessageClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">headers_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Attributes reset at various times for each request; not public</span>
    <span class="c1"># documented. Class attributes to keep the constructor fast</span>
    <span class="c1"># (but not make lint tools complain)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># byte string: b&#39;200 OK&#39;</span>
    <span class="n">_orig_status</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># native string: &#39;200 OK&#39;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># list of tuples (b&#39;name&#39;, b&#39;value&#39;)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Integer parsed from status</span>
    <span class="n">provided_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">provided_content_length</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">close_connection</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># time.time() when begin handling request</span>
    <span class="n">time_finish</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># time.time() when done handling request</span>
    <span class="n">headers_sent</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Have we already sent headers?</span>
    <span class="n">response_use_chunked</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Write with transfer-encoding chunked</span>
    <span class="c1"># Was the connection upgraded? We shouldn&#39;t try to chunk writes in that</span>
    <span class="c1"># case.</span>
    <span class="n">connection_upgraded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Dict from self.get_environ</span>
    <span class="n">application</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># application callable from self.server.application</span>
    <span class="n">requestline</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># native str &#39;GET / HTTP/1.1&#39;</span>
    <span class="n">response_length</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># How much data we sent</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># The return value of the WSGI application</span>
    <span class="n">wsgi_input</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Instance of Input()</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># From application-provided headers Incoming</span>
    <span class="c1"># request headers, instance of MessageClass (gunicorn uses hasattr</span>
    <span class="c1"># on this so the default value needs to be compatible with the</span>
    <span class="c1"># API)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">headers_factory</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">())</span>
    <span class="n">request_version</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># str: &#39;HTTP 1.1&#39;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># str: &#39;GET&#39;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># str: &#39;/&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">rfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Deprecation: The rfile kwarg was introduced in 1.0a1 as part</span>
        <span class="c1"># of a refactoring. It was never documented or used. It is</span>
        <span class="c1"># considered DEPRECATED and may be removed in the future. Its</span>
        <span class="c1"># use is not supported.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="k">if</span> <span class="n">rfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main request handling method, called by the server.</span>

<span class="sd">        This method runs a request handling loop, calling</span>
<span class="sd">        :meth:`handle_one_request` until all requests on the</span>
<span class="sd">        connection have been handled (that is, it implements</span>
<span class="sd">        keep-alive).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_request</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response_body</span> <span class="o">=</span> <span class="n">result</span> <span class="c1"># pylint:disable=unpacking-non-sequence</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_request</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_sock</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;_sock&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Python 3</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># read out request data to prevent error: [Errno 104] Connection reset by peer</span>
                    <span class="k">if</span> <span class="n">_sock</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># socket.recv would hang</span>
                            <span class="n">_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16384</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;rfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;wsgi_input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_http_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">version_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HTTP/&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>  <span class="c1"># &quot;HTTP/&quot;</span>
        <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_requestline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the incoming request.</span>

<span class="sd">        Parses various headers into ``self.headers`` using</span>
<span class="sd">        :attr:`MessageClass`. Other attributes that are set upon a successful</span>
<span class="sd">        return of this method include ``self.content_length`` and ``self.close_connection``.</span>

<span class="sd">        :param str raw_requestline: A native :class:`str` representing</span>
<span class="sd">           the request line. A processed version of this will be stored</span>
<span class="sd">           into ``self.requestline``.</span>

<span class="sd">        :raises ValueError: If the request is invalid. This error will</span>
<span class="sd">           not be logged as a traceback (because it&#39;s a client issue, not a server problem).</span>
<span class="sd">        :return: A boolean value indicating whether the request was successfully parsed.</span>
<span class="sd">           This method should either return a true value or have raised a ValueError</span>
<span class="sd">           with details about the parsing error.</span>

<span class="sd">        .. versionchanged:: 1.1b6</span>
<span class="sd">           Raise the previously documented :exc:`ValueError` in more cases instead of returning a</span>
<span class="sd">           false value; this allows subclasses more opportunity to customize behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint:disable=too-many-branches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="n">raw_requestline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="n">words</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_http_version</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Invalid http version: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">raw_requestline</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">words</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">!=</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Expected GET method; Got command=</span><span class="si">%r</span><span class="s1">; path=</span><span class="si">%r</span><span class="s1">; raw=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">raw_requestline</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="s2">&quot;HTTP/0.9&quot;</span>
            <span class="c1"># QQQ I&#39;m pretty sure we can drop support for HTTP/0.9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Invalid HTTP method: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">raw_requestline</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MessageClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Invalid headers status: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">status</span><span class="p">,))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transfer-encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;chunked&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-length&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">content_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Invalid Content-Length: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">content_length</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">content_length</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="n">_InvalidClientRequest</span><span class="p">(</span><span class="s1">&#39;Unexpected Content-Length&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="n">content_length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">==</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="n">conntype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="p">(</span><span class="n">conntype</span> <span class="o">==</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span> <span class="c1"># pylint:disable=superfluous-parens</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.0&#39;</span><span class="p">:</span>
            <span class="n">conntype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="p">(</span><span class="n">conntype</span> <span class="o">!=</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">)</span> <span class="c1"># pylint:disable=superfluous-parens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># XXX: HTTP 0.9. We should drop support</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">_print_unexpected_exc</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># Already fully formatted, no need to do it again; msg</span>
            <span class="c1"># might contain % chars that would lead to a formatting</span>
            <span class="c1"># error.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">%</span> <span class="n">args</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># pylint:disable=broad-except</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_unexpected_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># pylint:disable=broad-except</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># pylint:disable=broad-except</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_unexpected_exc</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_requestline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return the HTTP request line.</span>

<span class="sd">        Under both Python 2 and 3, this should return the native</span>
<span class="sd">        ``str`` type; under Python 3, this probably means the bytes read</span>
<span class="sd">        from the network need to be decoded (using the ISO-8859-1 charset, aka</span>
<span class="sd">        latin-1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">MAX_REQUEST_LINE</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_one_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles one HTTP request using ``self.socket`` and ``self.rfile``.</span>

<span class="sd">        Each invocation of this method will do several things, including (but not limited to):</span>

<span class="sd">        - Read the request line using :meth:`read_requestline`;</span>
<span class="sd">        - Read the rest of the request, including headers, with :meth:`read_request`;</span>
<span class="sd">        - Construct a new WSGI environment in ``self.environ`` using :meth:`get_environ`;</span>
<span class="sd">        - Store the application in ``self.application``, retrieving it from the server;</span>
<span class="sd">        - Handle the remainder of the request, including invoking the application,</span>
<span class="sd">          with :meth:`handle_one_response`</span>

<span class="sd">        There are several possible return values to indicate the state</span>
<span class="sd">        of the client connection:</span>

<span class="sd">        - ``None``</span>
<span class="sd">            The client connection is already closed or should</span>
<span class="sd">            be closed because the WSGI application or client set the</span>
<span class="sd">            ``Connection: close`` header. The request handling</span>
<span class="sd">            loop should terminate and perform cleanup steps.</span>
<span class="sd">        - (status, body)</span>
<span class="sd">            An HTTP status and body tuple. The request was in error,</span>
<span class="sd">            as detailed by the status and body. The request handling</span>
<span class="sd">            loop should terminate, close the connection, and perform</span>
<span class="sd">            cleanup steps. Note that the ``body`` is the complete contents</span>
<span class="sd">            to send to the client, including all headers and the initial</span>
<span class="sd">            status line.</span>
<span class="sd">        - ``True``</span>
<span class="sd">            The literal ``True`` value. The request was successfully handled</span>
<span class="sd">            and the response sent to the client by :meth:`handle_one_response`.</span>
<span class="sd">            The connection remains open to process more requests and the connection</span>
<span class="sd">            handling loop should call this method again. This is the typical return</span>
<span class="sd">            value.</span>

<span class="sd">        .. seealso:: :meth:`handle`</span>

<span class="sd">        .. versionchanged:: 1.1b6</span>
<span class="sd">           Funnel exceptions having to do with invalid HTTP requests through</span>
<span class="sd">           :meth:`_handle_client_error` to allow subclasses to customize. Note that</span>
<span class="sd">           this is experimental and may change in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint:disable=too-many-return-statements</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_requestline</span><span class="p">()</span>
            <span class="c1"># Account for old subclasses that haven&#39;t done this</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="c1"># &quot;Connection reset by peer&quot; or other socket errors aren&#39;t interesting here</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response_length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_REQUEST_LINE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;414&#39;</span><span class="p">,</span> <span class="n">_REQUEST_TOO_LONG_RESPONSE</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># for compatibility with older versions of pywsgi, we pass self.requestline as an argument there</span>
            <span class="c1"># NOTE: read_request is supposed to raise ValueError on invalid input; allow old</span>
            <span class="c1"># subclasses that return a False value instead.</span>
            <span class="c1"># NOTE: This can mutate the value of self.headers, so self.get_environ() must not be</span>
            <span class="c1"># called until AFTER this call is done.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;400&#39;</span><span class="p">,</span> <span class="n">_BAD_REQUEST_RESPONSE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> <span class="c1"># pylint:disable=broad-except</span>
            <span class="c1"># Notice we don&#39;t use self.handle_error because it reports</span>
            <span class="c1"># a 500 error to the client, and this is almost certainly</span>
            <span class="c1"># a client error.</span>
            <span class="c1"># Provide a hook for subclasses.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_client_error</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">application</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_response</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># read more requests</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connection_upgrade_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;websocket&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finalize_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection_upgraded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">101</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="mi">204</span><span class="p">):</span>
            <span class="c1"># the reply will include message-body; make sure we have either Content-Length or chunked</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                    <span class="n">total_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">total_len_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_len</span><span class="p">)</span>
                    <span class="n">total_len_str</span> <span class="o">=</span> <span class="n">total_len_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="n">total_len_str</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response_use_chunked</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_upgraded</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">!=</span> <span class="s1">&#39;HTTP/1.0&#39;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_use_chunked</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;Transfer-Encoding&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;chunked&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sendall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;socket error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ex</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
               <span class="n">_bytearray</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># The application/middleware are allowed to yield</span>
            <span class="c1"># empty bytestrings.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_use_chunked</span><span class="p">:</span>
            <span class="c1"># Write the chunked encoding header</span>
            <span class="n">header_str</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%x</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">towrite</span> <span class="o">=</span> <span class="n">_bytearray</span><span class="p">(</span><span class="n">header_str</span><span class="p">)</span>

            <span class="c1"># data</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="c1"># trailer</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendall</span><span class="p">(</span><span class="n">towrite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">ApplicationError</span> <span class="o">=</span> <span class="ne">AssertionError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># The write() callable we return from start_response.</span>
        <span class="c1"># https://www.python.org/dev/peps/pep-3333/#the-write-callable</span>
        <span class="c1"># Supposed to do pretty much the same thing as yielding values</span>
        <span class="c1"># from the application&#39;s return.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ApplicationError</span><span class="p">(</span><span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> response must have no body&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ApplicationError</span><span class="p">(</span><span class="s2">&quot;The application did not call start_response()&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_with_headers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_with_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalize_headers</span><span class="p">()</span>

        <span class="c1"># self.response_headers and self.status are already in latin-1, as encoded by self.start_response</span>
        <span class="n">towrite</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;HTTP/1.1 &#39;</span><span class="p">)</span>
        <span class="n">towrite</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="n">towrite</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">:</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="n">header</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;: &#39;</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="n">towrite</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="n">towrite</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendall</span><span class="p">(</span><span class="n">towrite</span><span class="p">)</span>
        <span class="c1"># No need to copy the data into towrite; we may make an extra syscall</span>
        <span class="c1"># but the copy time could be substantial too, and it reduces the chances</span>
        <span class="c1"># of sendall being able to send everything in one go</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         .. versionchanged:: 1.2a1</span>
<span class="sd">            Avoid HTTP header injection by raising a :exc:`ValueError`</span>
<span class="sd">            if *status* or any *header* name or value contains a carriage</span>
<span class="sd">            return or newline.</span>
<span class="sd">         .. versionchanged:: 1.1b5</span>
<span class="sd">            Pro-actively handle checking the encoding of the status line</span>
<span class="sd">            and headers during this method. On Python 2, avoid some</span>
<span class="sd">            extra encodings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint:disable=too-many-branches,too-many-statements</span>
        <span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span><span class="p">:</span>
                    <span class="c1"># Re-raise original exception if headers sent</span>
                    <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Avoid dangling circular ref</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Pep 3333, &quot;The start_response callable&quot;:</span>
        <span class="c1"># https://www.python.org/dev/peps/pep-3333/#the-start-response-callable</span>
        <span class="c1"># &quot;Servers should check for errors in the headers at the time</span>
        <span class="c1"># start_response is called, so that an error can be raised</span>
        <span class="c1"># while the application is still running.&quot; Here, we check the encoding.</span>
        <span class="c1"># This aids debugging: headers especially are generated programmatically</span>
        <span class="c1"># and an encoding error in a loop or list comprehension yields an opaque</span>
        <span class="c1"># UnicodeError without any clue which header was wrong.</span>
        <span class="c1"># Note that this results in copying the header list at this point, not modifying it,</span>
        <span class="c1"># although we are allowed to do so if needed. This slightly increases memory usage.</span>
        <span class="c1"># We also check for HTTP Response Splitting vulnerabilities</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">UnicodeError</span><span class="p">(</span><span class="s2">&quot;The header must be a native string&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">UnicodeError</span><span class="p">(</span><span class="s2">&quot;The value must be a native string&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;carriage return or newline in header name&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;carriage return or newline in header value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1"># Either we&#39;re on Python 2, in which case bytes is correct, or</span>
                <span class="c1"># we&#39;re on Python 3 and the user screwed up (because it should be a native</span>
                <span class="c1"># string). In either case, make sure that this is latin-1 compatible. Under</span>
                <span class="c1"># Python 2, bytes.encode() will take a round-trip through the system encoding,</span>
                <span class="c1"># which may be ascii, which is not really what we want. However, the latin-1 encoding</span>
                <span class="c1"># can encode everything except control characters and the block from 0x7F to 0x9F, so</span>
                <span class="c1"># explicitly round-tripping bytes through the encoding is unlikely to be of much</span>
                <span class="c1"># benefit, so we go for speed (the WSGI spec specifically calls out allowing the range</span>
                <span class="c1"># from 0x00 to 0xFF, although the HTTP spec forbids the control characters).</span>
                <span class="c1"># Note: Some Python 2 implementations, like Jython, may allow non-octet (above 255) values</span>
                <span class="c1"># in their str implementation; this is mentioned in the WSGI spec, but we don&#39;t</span>
                <span class="c1"># run on any platform like that so we can assume that a str value is pure bytes.</span>
                <span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">),</span>
                                         <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="c1"># If we get here, we&#39;re guaranteed to have a header and value</span>
            <span class="k">raise</span> <span class="ne">UnicodeError</span><span class="p">(</span><span class="s2">&quot;Non-latin1 header&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="c1"># Same as above</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">UnicodeError</span><span class="p">(</span><span class="s2">&quot;The status string must be a native string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;carriage return or newline in status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="c1"># don&#39;t assign to anything until the validation is complete, including parsing the</span>
        <span class="c1"># code</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_status</span> <span class="o">=</span> <span class="n">status</span> <span class="c1"># Preserve the native string for logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span> <span class="o">=</span> <span class="n">response_headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

        <span class="n">provided_connection</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Did the wsgi app give us a Connection header?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="s1">&#39;connection&#39;</span><span class="p">:</span>
                <span class="n">provided_connection</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">provided_date</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.0&#39;</span> <span class="ow">and</span> <span class="n">provided_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conntype</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;close&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;keep-alive&#39;</span>
            <span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="n">conntype</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">provided_connection</span> <span class="o">==</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="mi">204</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid Content-Length for </span><span class="si">%s</span><span class="s1"> response: </span><span class="si">%r</span><span class="s1"> (must be absent or zero)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_content_length</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ApplicationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_request</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_length</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - - [</span><span class="si">%s</span><span class="s1">] &quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">client_address</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
            <span class="n">now</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="c1"># Use the native string version of the status, saved so we don&#39;t have to</span>
            <span class="c1"># decode. But fallback to the encoded &#39;status&#39; in case of subclasses</span>
            <span class="c1"># (Is that really necessary? At least there&#39;s no overhead.)</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_status</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">or</span> <span class="s1">&#39;000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">length</span><span class="p">,</span>
            <span class="n">delta</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span><span class="p">:</span>
            <span class="c1"># In other words, the application returned an empty</span>
            <span class="c1"># result iterable (and did not use the write callable)</span>
            <span class="c1"># Trigger the flush of the headers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_use_chunked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendall</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">run_application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_result</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">close</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Discard the result. If it&#39;s a generator this can</span>
                <span class="c1"># free a lot of hidden resources (if we failed to iterate</span>
                <span class="c1"># all the way through it---the frames are automatically</span>
                <span class="c1"># cleaned up when StopIteration is raised); but other cases</span>
                <span class="c1"># could still free up resources sooner than otherwise.</span>
                <span class="n">close</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: These errors are silently ignored by :meth:`handle_one_response` to avoid producing</span>
    <span class="c1">#: excess log entries on normal operating conditions. They indicate</span>
    <span class="c1">#: a remote client has disconnected and there is little or nothing</span>
    <span class="c1">#: this process can be expected to do about it. You may change this</span>
    <span class="c1">#: value in a subclass.</span>
    <span class="c1">#:</span>
    <span class="c1">#: The default value includes :data:`errno.EPIPE` and :data:`errno.ECONNRESET`.</span>
    <span class="c1">#: On Windows this also includes :data:`errno.WSAECONNABORTED`.</span>
    <span class="c1">#:</span>
    <span class="c1">#: This is a provisional API, subject to change. See :pr:`377`, :pr:`999`</span>
    <span class="c1">#: and :issue:`136`.</span>
    <span class="c1">#:</span>
    <span class="c1">#: .. versionadded:: 1.3</span>
    <span class="n">ignored_socket_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ignored_socket_errors</span> <span class="o">+=</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">WSAECONNABORTED</span><span class="p">,)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1"># Not windows</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_one_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke the application to produce one response.</span>

<span class="sd">        This is called by :meth:`handle_one_request` after all the</span>
<span class="sd">        state for the request has been established. It is responsible</span>
<span class="sd">        for error handling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_use_chunked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_upgraded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_application</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_input</span><span class="o">.</span><span class="n">_discard</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">_InvalidClientInput</span><span class="p">:</span>
                    <span class="c1"># This one is deliberately raised to the outer</span>
                    <span class="c1"># scope, because, with the incoming stream in some bad state,</span>
                    <span class="c1"># we can&#39;t be sure we can synchronize and properly parse the next</span>
                    <span class="c1"># request.</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t let socket exceptions during discarding</span>
                    <span class="c1"># input override any exception that may have been</span>
                    <span class="c1"># raised by the application, such as our own _InvalidClientInput.</span>
                    <span class="c1"># In the general case, these aren&#39;t even worth logging (see the comment</span>
                    <span class="c1"># just below)</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="n">_InvalidClientInput</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c1"># DO log this one because:</span>
            <span class="c1"># - Some of the data may have been read and acted on by the</span>
            <span class="c1">#   application;</span>
            <span class="c1"># - The response may or may not have been sent;</span>
            <span class="c1"># - It&#39;s likely that the client is bad, or malicious, and</span>
            <span class="c1">#   users might wish to take steps to block the client.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_client_error</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_error_response_if_possible</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored_socket_errors</span><span class="p">:</span>
                <span class="c1"># See description of self.ignored_socket_errors.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># pylint:disable=bare-except</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_request</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_send_error_response_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_code</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">_ERRORS</span><span class="p">[</span><span class="n">error_code</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># TODO: Shouldn&#39;t we dump this to wsgi.errors? If we did that now, it would</span>
        <span class="c1"># wind up getting logged twice</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">GreenletExit</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">secure_environ_class</span><span class="p">):</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">secure_environ_class</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># Called for internal, unexpected errors, NOT invalid client input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_error_response_if_possible</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_client_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
        <span class="c1"># Called for invalid client input</span>
        <span class="c1"># Returns the appropriate error response.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">_InvalidClientInput</span><span class="p">)):</span>
            <span class="c1"># XXX: Why not self._log_error to send it through the loop&#39;s</span>
            <span class="c1"># handle_error method?</span>
            <span class="c1"># _InvalidClientRequest is a ValueError; _InvalidClientInput is an IOError.</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">_InvalidClientRequest</span><span class="p">):</span>
            <span class="c1"># No formatting needed, that&#39;s already been handled. In fact, because the</span>
            <span class="c1"># formatted message contains user input, it might have a % in it, and attempting</span>
            <span class="c1"># to format that with no arguments would be an error.</span>
            <span class="c1"># However, the error messages do not include the requesting IP</span>
            <span class="c1"># necessarily, so we do add that.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s1">&#39;(from </span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">formatted_message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s1">&#39;Invalid request (from </span><span class="si">%s</span><span class="s1">): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">,</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ex</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;400&#39;</span><span class="p">,</span> <span class="n">_BAD_REQUEST_RESPONSE</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">IGNORED_KEYS</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;CONTENT_LENGTH&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot; </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">header</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IGNORED_KEYS</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;HTTP_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="c1"># strip incoming bad veaders</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IGNORED_KEYS</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;HTTP_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct and return a new WSGI environment dictionary for a specific request.</span>

<span class="sd">        This should begin with asking the server for the base environment</span>
<span class="sd">        using :meth:`WSGIServer.get_environ`, and then proceed to add the</span>
<span class="sd">        request specific values.</span>

<span class="sd">        By the time this method is invoked the request line and request shall have</span>
<span class="sd">        been parsed and ``self.headers`` shall be populated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>
        <span class="c1"># SCRIPT_NAME is explicitly implementation defined. Using an</span>
        <span class="c1"># empty value for SCRIPT_NAME is both explicitly allowed by</span>
        <span class="c1"># both the CGI standard and WSGI PEPs, and also the thing that</span>
        <span class="c1"># makes the most sense from a generic server perspective (we</span>
        <span class="c1"># have no hierarchy or understanding of URLs or files, just a</span>
        <span class="c1"># single application to call. The empty string represents the</span>
        <span class="c1"># application root, which is what we have). Different WSGI</span>
        <span class="c1"># implementations handle this very differently, so portable</span>
        <span class="c1"># applications that rely on SCRIPT_NAME will have to use a</span>
        <span class="c1"># WSGI middleware to set it to a defined value, or otherwise</span>
        <span class="c1"># rely on server-specific mechanisms (e.g, on waitress, use</span>
        <span class="c1"># ``--url-prefix``, in gunicorn set the ``SCRIPT_NAME`` header</span>
        <span class="c1"># or process environment variable, in gevent subclass</span>
        <span class="c1"># WSGIHandler.)</span>
        <span class="c1">#</span>
        <span class="c1"># See https://github.com/gevent/gevent/issues/1667 for discussion.</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">path</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Note that self.path contains the original str object; if it contains</span>
        <span class="c1"># encoded escapes, it will NOT match PATH_INFO.</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unquote_latin1</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;QUERY_STRING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">typeheader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">typeheader</span>

        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SERVER_PROTOCOL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span>

        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client_address</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;REMOTE_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;COOKIE&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; &#39;</span> <span class="o">+</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_EXPECT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;100-continue&#39;</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">chunked</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_TRANSFER_ENCODING&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chunked&#39;</span>
        <span class="c1"># Input refuses to read if the data isn&#39;t chunked, and there is no content_length</span>
        <span class="c1"># provided. For &#39;Upgrade: Websocket&#39; requests, neither of those things is true.</span>
        <span class="n">handling_reads</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_upgrade_requested</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span><span class="p">,</span> <span class="n">socket</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span> <span class="n">chunked_input</span><span class="o">=</span><span class="n">chunked</span><span class="p">)</span>

        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_input</span> <span class="k">if</span> <span class="n">handling_reads</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span>
        <span class="c1"># This is a non-standard flag indicating that our input stream is</span>
        <span class="c1"># self-terminated (returns EOF when consumed).</span>
        <span class="c1"># See https://github.com/gevent/gevent/issues/1308</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.input_terminated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handling_reads</span>
        <span class="k">return</span> <span class="n">env</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_NoopLog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Does nothing; implements just enough file-like methods</span>
    <span class="c1"># to pass the WSGI validator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint:disable=unused-argument</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoggingLogAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An adapter for :class:`logging.Logger` instances</span>
<span class="sd">    to let them be used with :class:`WSGIServer`.</span>

<span class="sd">    .. warning:: Unless the entire process is monkey-patched at a very</span>
<span class="sd">        early part of the lifecycle (before logging is configured),</span>
<span class="sd">        loggers are likely to not be gevent-cooperative. For example,</span>
<span class="sd">        the socket and syslog handlers use the socket module in a way</span>
<span class="sd">        that can block, and most handlers acquire threading locks.</span>

<span class="sd">    .. warning:: It *may* be possible for the logging functions to be</span>
<span class="sd">       called in the :class:`gevent.Hub` greenlet. Code running in the</span>
<span class="sd">       hub greenlet cannot use any gevent blocking functions without triggering</span>
<span class="sd">       a ``LoopExit``.</span>

<span class="sd">    .. versionadded:: 1.1a3</span>

<span class="sd">    .. versionchanged:: 1.1b6</span>
<span class="sd">       Attributes not present on this object are proxied to the underlying</span>
<span class="sd">       logger instance. This permits using custom :class:`~logging.Logger`</span>
<span class="sd">       subclasses (or indeed, even duck-typed objects).</span>

<span class="sd">    .. versionchanged:: 1.1</span>
<span class="sd">       Strip trailing newline characters on the message passed to :meth:`write`</span>
<span class="sd">       because log handlers will usually add one themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># gevent avoids importing and using logging because importing it and</span>
    <span class="c1"># creating loggers creates native locks unless monkey-patched.</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_logger&#39;</span><span class="p">,</span> <span class="s1">&#39;_level&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write information to the *logger* at the given *level* (default to INFO).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;No-op; required to be a file-like object&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LoggingLogAdapter</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="c1">####</span>
<span class="c1">## Environ classes.</span>
<span class="c1"># These subclass dict. They could subclass collections.UserDict on</span>
<span class="c1"># 3.3+ and proxy to the underlying real dict to avoid a copy if we</span>
<span class="c1"># have to print them (on 2.7 it&#39;s slightly more complicated to be an</span>
<span class="c1"># instance of collections.MutableMapping; UserDict.UserDict isn&#39;t.)</span>
<span class="c1"># Then we could have either the WSGIHandler.get_environ or the</span>
<span class="c1"># WSGIServer.get_environ return one of these proxies, and</span>
<span class="c1"># WSGIHandler.run_application would know to access the `environ.data`</span>
<span class="c1"># attribute to be able to pass the *real* dict to the application</span>
<span class="c1"># (because PEP3333 requires no subclasses, only actual dict objects;</span>
<span class="c1"># wsgiref.validator and webob.Request both enforce this). This has the</span>
<span class="c1"># advantage of not being fragile if anybody else tries to print/log</span>
<span class="c1"># self.environ (and not requiring a copy). However, if there are any</span>
<span class="c1"># subclasses of Handler or Server, this could break if they don&#39;t know</span>
<span class="c1"># to return this type.</span>
<span class="c1">####</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Environ</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base class that can be used for WSGI environment objects.</span>

<span class="sd">    Provisional API.</span>

<span class="sd">    .. versionadded:: 1.2a1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span> <span class="c1"># add no ivars or weakref ability</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;iteritems&#39;</span><span class="p">):</span>
        <span class="c1"># Python 3</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureEnviron</span><span class="p">(</span><span class="n">Environ</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An environment that does not print its keys and values</span>
<span class="sd">    by default.</span>

<span class="sd">    Provisional API.</span>

<span class="sd">    This is intended to keep potentially sensitive information like</span>
<span class="sd">    HTTP authorization and cookies from being inadvertently printed</span>
<span class="sd">    or logged.</span>

<span class="sd">    For debugging, each instance can have its *secure_repr* attribute</span>
<span class="sd">    set to ``False``, which will cause it to print like a normal dict.</span>

<span class="sd">    When *secure_repr* is ``True`` (the default), then the value of</span>
<span class="sd">    the *whitelist_keys* attribute is consulted; if this value is</span>
<span class="sd">    true-ish, it should be a container (something that responds to</span>
<span class="sd">    ``in``) of key names (typically a list or set). Keys and values in</span>
<span class="sd">    this dictionary that are in *whitelist_keys* will then be printed,</span>
<span class="sd">    while all other values will be masked. These values may be</span>
<span class="sd">    customized on the class by setting the *default_secure_repr* and</span>
<span class="sd">    *default_whitelist_keys*, respectively::</span>

<span class="sd">        &gt;&gt;&gt; environ = SecureEnviron(key=&#39;value&#39;)</span>
<span class="sd">        &gt;&gt;&gt; environ # doctest: +ELLIPSIS</span>
<span class="sd">        &lt;pywsgi.SecureEnviron dict (keys: 1) at ...</span>

<span class="sd">    If we whitelist the key, it gets printed::</span>

<span class="sd">        &gt;&gt;&gt; environ.whitelist_keys = {&#39;key&#39;}</span>
<span class="sd">        &gt;&gt;&gt; environ</span>
<span class="sd">        {&#39;key&#39;: &#39;value&#39;}</span>

<span class="sd">    A non-whitelisted key (*only*, to avoid doctest issues) is masked::</span>

<span class="sd">        &gt;&gt;&gt; environ[&#39;secure&#39;] = &#39;secret&#39;; del environ[&#39;key&#39;]</span>
<span class="sd">        &gt;&gt;&gt; environ</span>
<span class="sd">        {&#39;secure&#39;: &#39;&lt;MASKED&gt;&#39;}</span>

<span class="sd">    We can turn it off entirely for the instance::</span>

<span class="sd">        &gt;&gt;&gt; environ.secure_repr = False</span>
<span class="sd">        &gt;&gt;&gt; environ</span>
<span class="sd">        {&#39;secure&#39;: &#39;secret&#39;}</span>

<span class="sd">    We can also customize it at the class level (here we use a new</span>
<span class="sd">    class to be explicit and to avoid polluting the true default</span>
<span class="sd">    values; we would set this class to be the ``environ_class`` of the</span>
<span class="sd">    server)::</span>

<span class="sd">        &gt;&gt;&gt; class MyEnviron(SecureEnviron):</span>
<span class="sd">        ...    default_whitelist_keys = (&#39;key&#39;,)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; environ = MyEnviron({&#39;key&#39;: &#39;value&#39;})</span>
<span class="sd">        &gt;&gt;&gt; environ</span>
<span class="sd">        {&#39;key&#39;: &#39;value&#39;}</span>

<span class="sd">    .. versionadded:: 1.2a1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_secure_repr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">default_whitelist_keys</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">default_print_masked_keys</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Allow instances to override the class values,</span>
    <span class="c1"># but inherit from the class if not present. Keeps instances</span>
    <span class="c1"># small since we can&#39;t combine __slots__ with class attributes</span>
    <span class="c1"># of the same name.</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;secure_repr&#39;</span><span class="p">,</span> <span class="s1">&#39;whitelist_keys&#39;</span><span class="p">,</span> <span class="s1">&#39;print_masked_keys&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">SecureEnviron</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;default_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secure_repr</span><span class="p">:</span>
            <span class="n">whitelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitelist_keys</span>
            <span class="n">print_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_masked_keys</span>
            <span class="k">if</span> <span class="n">whitelist</span><span class="p">:</span>
                <span class="n">safe</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">whitelist</span> <span class="k">else</span> <span class="s2">&quot;&lt;MASKED&gt;&quot;</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">whitelist</span> <span class="ow">or</span> <span class="n">print_masked</span><span class="p">}</span>
                <span class="n">safe_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">print_masked</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">safe_repr</span> <span class="o">=</span> <span class="n">safe_repr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, (hidden keys: </span><span class="si">%d</span><span class="s2">)}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">safe_repr</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;pywsgi.SecureEnviron dict (keys: </span><span class="si">%d</span><span class="s2">) at </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Environ</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WSGISecureEnviron</span><span class="p">(</span><span class="n">SecureEnviron</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specializes the default list of whitelisted keys to a few</span>
<span class="sd">    common WSGI variables.</span>

<span class="sd">    Example::</span>

<span class="sd">       &gt;&gt;&gt; environ = WSGISecureEnviron(REMOTE_ADDR=&#39;::1&#39;, HTTP_AUTHORIZATION=&#39;secret&#39;)</span>
<span class="sd">       &gt;&gt;&gt; environ</span>
<span class="sd">       {&#39;REMOTE_ADDR&#39;: &#39;::1&#39;, (hidden keys: 1)}</span>
<span class="sd">       &gt;&gt;&gt; import pprint</span>
<span class="sd">       &gt;&gt;&gt; pprint.pprint(environ)</span>
<span class="sd">       {&#39;REMOTE_ADDR&#39;: &#39;::1&#39;, (hidden keys: 1)}</span>
<span class="sd">       &gt;&gt;&gt; print(pprint.pformat(environ))</span>
<span class="sd">       {&#39;REMOTE_ADDR&#39;: &#39;::1&#39;, (hidden keys: 1)}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_whitelist_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">,</span> <span class="s1">&#39;REMOTE_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">)</span>
    <span class="n">default_print_masked_keys</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WSGIServer</span><span class="p">(</span><span class="n">StreamServer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A WSGI server based on :class:`StreamServer` that supports HTTPS.</span>


<span class="sd">    :keyword log: If given, an object with a ``write`` method to which</span>
<span class="sd">        request (access) logs will be written. If not given, defaults</span>
<span class="sd">        to :obj:`sys.stderr`. You may pass ``None`` to disable request</span>
<span class="sd">        logging. You may use a wrapper, around e.g., :mod:`logging`,</span>
<span class="sd">        to support objects that don&#39;t implement a ``write`` method.</span>
<span class="sd">        (If you pass a :class:`~logging.Logger` instance, or in</span>
<span class="sd">        general something that provides a ``log`` method but not a</span>
<span class="sd">        ``write`` method, such a wrapper will automatically be created</span>
<span class="sd">        and it will be logged to at the :data:`~logging.INFO` level.)</span>

<span class="sd">    :keyword error_log: If given, a file-like object with ``write``,</span>
<span class="sd">        ``writelines`` and ``flush`` methods to which error logs will</span>
<span class="sd">        be written. If not given, defaults to :obj:`sys.stderr`. You</span>
<span class="sd">        may pass ``None`` to disable error logging (not recommended).</span>
<span class="sd">        You may use a wrapper, around e.g., :mod:`logging`, to support</span>
<span class="sd">        objects that don&#39;t implement the proper methods. This</span>
<span class="sd">        parameter will become the value for ``wsgi.errors`` in the</span>
<span class="sd">        WSGI environment (if not already set). (As with *log*,</span>
<span class="sd">        wrappers for :class:`~logging.Logger` instances and the like</span>
<span class="sd">        will be created automatically and logged to at the :data:`~logging.ERROR`</span>
<span class="sd">        level.)</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :class:`LoggingLogAdapter`</span>
<span class="sd">            See important warnings before attempting to use :mod:`logging`.</span>

<span class="sd">    .. versionchanged:: 1.1a3</span>
<span class="sd">        Added the ``error_log`` parameter, and set ``wsgi.errors`` in the WSGI</span>
<span class="sd">        environment to this value.</span>
<span class="sd">    .. versionchanged:: 1.1a3</span>
<span class="sd">        Add support for passing :class:`logging.Logger` objects to the ``log`` and</span>
<span class="sd">        ``error_log`` arguments.</span>
<span class="sd">    .. versionchanged:: 20.6.0</span>
<span class="sd">        Passing a ``handle`` kwarg to the constructor is now officially deprecated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: A callable taking three arguments: (socket, address, server) and returning</span>
    <span class="c1">#: an object with a ``handle()`` method. The callable is called once for</span>
    <span class="c1">#: each incoming socket request, as is its handle method. The handle method should not</span>
    <span class="c1">#: return until all use of the socket is complete.</span>
    <span class="c1">#:</span>
    <span class="c1">#: This class uses the :class:`WSGIHandler` object as the default value. You may</span>
    <span class="c1">#: subclass this class and set a different default value, or you may pass</span>
    <span class="c1">#: a value to use in the ``handler_class`` keyword constructor argument.</span>
    <span class="n">handler_class</span> <span class="o">=</span> <span class="n">WSGIHandler</span>

    <span class="c1">#: The object to which request logs will be written.</span>
    <span class="c1">#: It must never be None. Initialized from the ``log`` constructor</span>
    <span class="c1">#: parameter.</span>
    <span class="n">log</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: The object to which error logs will be written.</span>
    <span class="c1">#: It must never be None. Initialized from the ``error_log`` constructor</span>
    <span class="c1">#: parameter.</span>
    <span class="n">error_log</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: The class of environ objects passed to the handlers.</span>
    <span class="c1">#: Must be a dict subclass. For compliance with :pep:`3333`</span>
    <span class="c1">#: and libraries like WebOb, this is simply :class:`dict`</span>
    <span class="c1">#: but this can be customized in a subclass or per-instance</span>
    <span class="c1">#: (probably to :class:`WSGISecureEnviron`).</span>
    <span class="c1">#:</span>
    <span class="c1">#: .. versionadded:: 1.2a1</span>
    <span class="n">environ_class</span> <span class="o">=</span> <span class="nb">dict</span>

    <span class="c1"># Undocumented internal detail: the class that WSGIHandler._log_error</span>
    <span class="c1"># will cast to before passing to the loop.</span>
    <span class="n">secure_environ_class</span> <span class="o">=</span> <span class="n">WSGISecureEnviron</span>

    <span class="n">base_env</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GATEWAY_INTERFACE&#39;</span><span class="p">:</span> <span class="s1">&#39;CGI/1.1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SERVER_SOFTWARE&#39;</span><span class="p">:</span> <span class="s1">&#39;gevent/</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1"> Python/</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                <span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;wsgi.version&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;wsgi.multithread&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># XXX: Aren&#39;t we really, though?</span>
                <span class="s1">&#39;wsgi.multiprocess&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;wsgi.run_once&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spawn</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                 <span class="n">log</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">error_log</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                 <span class="n">handler_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ssl_args</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;handle&#39;</span> <span class="ow">in</span> <span class="n">ssl_args</span><span class="p">:</span>
            <span class="c1"># The ultimate base class (BaseServer) uses &#39;handle&#39; for</span>
            <span class="c1"># the thing we call &#39;application&#39;. We never deliberately</span>
            <span class="c1"># bass a `handle` argument to the base class, but one</span>
            <span class="c1"># could sneak in through ``**ssl_args``, even though that</span>
            <span class="c1"># is not the intent, while application is None. That</span>
            <span class="c1"># causes our own ``def handle`` method to be replaced,</span>
            <span class="c1"># probably leading to bad results. Passing a &#39;handle&#39;</span>
            <span class="c1"># instead of an &#39;application&#39; can really confuse things.</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Passing &#39;handle&#39; kwarg to WSGIServer is deprecated. &quot;</span>
                          <span class="s2">&quot;Did you mean application?&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">StreamServer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">,</span> <span class="n">spawn</span><span class="o">=</span><span class="n">spawn</span><span class="p">,</span> <span class="o">**</span><span class="n">ssl_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">application</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="k">if</span> <span class="n">handler_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span> <span class="o">=</span> <span class="n">handler_class</span>

        <span class="c1"># Note that we can&#39;t initialize these as class variables:</span>
        <span class="c1"># sys.stderr might get monkey patched at runtime.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_make_log</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_NoopLog</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">LoggingLogAdapter</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">_make_log</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="n">_make_log</span><span class="p">(</span><span class="n">error_log</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span> <span class="c1"># logging.ERROR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_max_accept</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">environ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>
        <span class="n">environ_update</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environ&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_env</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>
        <span class="k">if</span> <span class="n">environ_update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">environ_update</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wsgi.errors&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_max_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wsgi.multiprocess&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_accept</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">StreamServer</span><span class="o">.</span><span class="n">init_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_environ</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called before the first request is handled to fill in WSGI environment values.</span>

<span class="sd">        This includes getting the correct server name and port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;SERVER_NAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of :attr:`handler_class` to handle the request.</span>

<span class="sd">        This method blocks until the handler returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint:disable=method-hidden</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_main</span><span class="p">():</span>
    <span class="c1"># Provisional main handler, for quick tests, not production</span>
    <span class="c1"># usage.</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">gevent</span><span class="w"> </span><span class="kn">import</span> <span class="n">monkey</span><span class="p">;</span> <span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;dotted name of WSGI app callable [module:callable]&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--bind&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The socket to bind&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;:8080&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">module_name</span><span class="p">,</span> <span class="n">app_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">app_name</span><span class="p">)</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bind</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">_main</span><span class="p">()</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Ashley Dalmeida
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/./furo_mod.js?v=fb588d8d"></script>
    </body>
</html>